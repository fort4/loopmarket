<div th:fragment="content" class="d-flex flex-column align-items-center w-100 px-3 px-md-0" style="max-width: 768px; margin: 0 auto;">
    <h4 class="mb-4">📨 나의 채팅방</h4>

    <!-- 채팅방 없을 경우 메시지 -->
    <div th:if="${chatSummaries != null and #lists.isEmpty(chatSummaries)}">
        <p class="text-muted">참여 중인 채팅방이 없습니다.</p>
    </div>

    <!-- 채팅방 목록 -->
    <div class="list-group w-100" th:if="${chatSummaries != null and !#lists.isEmpty(chatSummaries)}">
        <a th:each="summary : ${chatSummaries}"
           th:href="@{/chat/room/{id}(id=${summary.room.roomId})}"
           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 fs-6">

            <div class="d-flex flex-column">
                <!-- 닉네임 -->
                <div>
                    <i class="bi bi-person-circle me-2"></i>
                    <strong th:text="${summary.opponentNickname}">상대방</strong>
                </div>
                <!-- 마지막 메시지 -->
                <div class="text-muted small" th:id="'chat-msg-' + ${summary.room.roomId}" th:text="${summary.lastMessage}">(메시지 없음)</div>
            </div>
			
   			<!-- 채팅방 목록 우측에 채팅온 개수(뱃지) -->
		   <div class="text-end" style="min-width: 60px;">
		       <!-- badge 추가 -->
		       <span class="badge rounded-pill bg-danger"
		             th:id="'chat-badge-' + ${summary.room.roomId}"
		             style="font-size: 0.8rem; display: none;">
		           <!-- JS에서 숫자 삽입 -->
		       </span><br/>
    			<!-- 마지막 메시지 시간 -->
		       <small class="text-muted" th:if="${summary.lastTime != null}" th:id="'chat-time-' + ${summary.room.roomId}"
		              th:text="${#temporals.format(summary.lastTime, 'MM/dd HH:mm')}">00:00</small>
		   </div>
        </a>
    </div> <!--채팅방 목록 끝-->
	
	<script>
	$(document).ready(function () {
		function updateUnreadBadgesAndMessages() {
		    $.get("/chat/api/unread-summary", function (data) {
		        data.forEach(item => {
		            const badge = $("#chat-badge-" + item.roomId);
		            const msgBox = $("#chat-msg-" + item.roomId);
		            const timeBox = $("#chat-time-" + item.roomId);

		            // 뱃지 표시
		            if (item.unreadCount > 0) {
		                badge.text(item.unreadCount > 9 ? "." : item.unreadCount).show();
		            } else {
		                badge.hide();
		            }

		            // 메시지 내용, 시간 업데이트
		            if (msgBox.length > 0) {
		                msgBox.text(item.lastMessage || "(메시지 없음)");
		            }
		            if (timeBox.length > 0 && item.lastTime) {
		                const hhmm = item.lastTime.substring(11, 16); // "2025-06-04T17:21" → "17:21"
		                timeBox.text(hhmm);
		            }
		        });
		    });
		}
	    // chatList 진입시 최초 실행
	    updateUnreadBadgesAndMessages();
	    // 주기적으로 갱신
	    setInterval(updateUnreadBadgesAndMessages, 4000);
	});
	</script>

</div>
