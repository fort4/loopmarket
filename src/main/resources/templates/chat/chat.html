<div th:fragment="content">
	<!-- 나가기 버튼 -->
	<form th:action="@{/chat/exit}" method="post" th:each="room : ${chatRooms}" style="display: inline;">
	    <input type="hidden" th:value="${room.roomId}" name="roomId" />
	    <button type="submit" class="btn btn-sm btn-danger">나가기</button>
	</form>
	
    <h2>1:1 채팅</h2>
    
    <div id="chat-box" class="border rounded p-3 mb-3" style="height: 300px; overflow-y: auto;">
        <!-- 메시지 영역 -->
    </div>

    <div class="input-group">
        <input type="text" id="chat-input" class="form-control" placeholder="메시지를 입력하세요">
        <button id="chat-send-btn" class="btn btn-primary">보내기</button>
    </div>

    <script th:inline="javascript">
		
        const userId = /*[[${session.loginUser.userId}]]*/ '1';
        const targetId = /*[[${targetUserId}]]*/ '2';
        const roomId = /*[[${roomId}]]*/ '1';
		
		// 웹소켓 주소
        const ws = new WebSocket(`ws://localhost:8080/ws/socket/chat/${roomId}`);

        ws.onopen = () => {
            console.log("웹소켓 연결됨");
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const box = document.getElementById("chat-box");
            const isMine = msg.sender === userId;

            const bubble = document.createElement("div");
            bubble.className = "p-2 mb-2 rounded " + (isMine ? "bg-primary text-white text-end" : "bg-light");
            bubble.innerText = msg.content;
            box.appendChild(bubble);
            box.scrollTop = box.scrollHeight;
        };

		$("#chat-send-btn").on("click", function (e) {
		    e.preventDefault();

		    const content = $("#chat-input").val().trim();
		    if (content === "") return;

		    const msg = {
		        sender: userId,
		        receiver: targetId,
		        roomId: roomId,
		        content: content,
		        messageType: "TEXT"
		    };

		    // WebSocket 전송
		    if (ws.readyState === WebSocket.OPEN) {
		        ws.send(JSON.stringify(msg));
		    }

		    // AJAX로 서버에 메시지 저장 요청 (백업)
		    $.ajax({
		        type: "POST",
		        url: "/api/chat/message",
		        contentType: "application/json",
		        data: JSON.stringify(msg),
		        success: function () {
		            console.log("메시지 백업 성공");
		        },
		        error: function () {
		            console.error("백업 실패");
		        }
		    });

		    $("#chat-input").val("");
		});


        window.onbeforeunload = () => {
            ws.close();
        };
    </script>
</div>
