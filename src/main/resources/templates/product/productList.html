<style>

</style>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


<div th:fragment="content">


  <div class="container" style="margin-top: 40px;">
    <div class="mb-4">


      <!-- 검색 영역 -->
      <div class="product-list-page">
        <div th:replace="fragment/searchAndLocation :: searchAndLocation"
             th:with="showSearchTitle=${false}">
        </div>
      </div>


      <!-- 상품 등록 버튼 -->
      <div class="text-end mt-3">
        <button class="btn btn-primary" onclick="goToProductForm()">상품 등록</button>
      </div>
    </div>
    <!-- 위에 상단 영역 -->

    <div class="row align-items-start">
      <div class="col-md-3">
        <h5 class="mb-3"></h5>
        <div class="d-grid gap-2 mt-3">
          <button id="locationFilterBtn" class="btn btn-primary btn-sm">현재 위치 상품 보기</button>
          <button id="allProductBtn" class="btn btn-outline-secondary btn-sm">전국 상품 보기</button>
        </div>
        <div class="btn-group-vertical w-100" role="group" aria-label="카테고리 선택">
          <!-- 전체 버튼 -->
          <button type="button"
                  class="btn btn-outline-secondary text-start"
                  style="width: 100%;"
                  data-value=""
                  th:classappend="${not param.containsKey('category') or #strings.isEmpty(param.category)} ? ' active'">
            전체
          </button>

          <!-- 카테고리 버튼 반복 -->
          <button type="button"
                  class="btn btn-outline-secondary text-start category-btn"
                  style="width: 100%;"
                  th:each="cat : ${mainCategories}"
                  th:data-value="${cat.ctgCode}"
                  th:text="${cat.ctgName}"
                  th:classappend="${#strings.equals(param.category, cat.ctgCode.toString())} ? ' active'">
            카테고리명
          </button>

        </div>
        <!-- 가격 필터 -->
        <div class="mt-4 p-3 border rounded">
          <h6 class="fw-bold mb-3">가격</h6>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="filterByPrice(0, 5000)" data-min="0" data-max="5000">5,000원 이하</button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterByPrice(0, 10000)" data-min="0" data-max="10000">10,000원 이하</button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterByPrice(0, 20000)" data-min="0" data-max="20000">20,000원 이하</button>
          </div>

          <div class="mt-3 d-flex gap-2 align-items-center">
            <input type="number" class="form-control" id="minPrice" placeholder="최소" min="0">
            <span>-</span>
            <input type="number" class="form-control" id="maxPrice" placeholder="최대" min="0">
          </div>

          <button class="btn btn-sm btn-primary w-100 mt-2" onclick="applyPriceRange()">적용하기</button>
          <button class="btn btn-sm btn-outline-danger w-100 mt-2" onclick="resetPriceFilter()">가격 초기화</button> <!-- 여기 -->
        </div>

      </div>


      <!-- 상품 카드 그리드 -->
      <div class="col-md-9">
    <div class="row row-cols-1 row-cols-md-3 g-4">
      <!-- 상품 리스트 반복 출력 -->
      <div class="col" th:each="product : ${productList}">
        <a th:href="@{'/products/' + ${product.productId}}" class="text-decoration-none text-dark">
          <div class="card h-100 shadow-sm"
               th:classappend="${product.isDelivery == true ? ' border-delivery' : ''} + ' ' + ${product.status == 'RESERVED' ? 'reserved-card' : ''}">




          <!-- 이미지 영역 -->
            <div class="position-relative" style="height: 200px; overflow: hidden;">

              <!-- 슬라이더 이미지 먼저 -->
              <div class="slider-track d-flex"
                   th:style="'width:' + (${#lists.size(product.imagePaths)} * 100) + '%; height: 100%; transition: transform 0.5s ease;'"
                   th:attr="data-count=${product.imagePaths.size()}">
                <img th:each="img : ${product.imagePaths}"
                     th:src="@{${img}}"
                     th:style="'width:' + (100 / ${#lists.size(product.imagePaths)}) + '%; height: 100%; object-fit: cover; flex-shrink: 0;'"/>
              </div>

              <!-- 예약중 오버레이 (흐리게 + 텍스트) -->
              <div th:if="${product.status == 'RESERVED'}" class="reserved-overlay">
                <span class="reserved-text">예약중</span>
              </div>

              <!-- 판매완료 오버레이 (블러 + 텍스트) -->
              <div th:if="${product.status == 'SOLD'}" class="sold-overlay">
                <div class="sold-blur"></div>
                <span class="sold-text">판매완료</span>
              </div>

              <!-- 상태 뱃지 + BEST 뱃지 -->
              <div class="position-absolute top-0 start-0 z-20 d-flex flex-column" style="padding: 4px;">

                <!-- ✅ 상태 뱃지: SOLD, RESERVED가 아닐 때만 표시 -->
                <div th:if="${product.status == 'AVAILABLE'}"
                     th:replace="fragment/status_badge :: statusBadge(${product.status})"></div>

                <!-- ✅ BEST 뱃지는 항상 표시 -->
                <div th:if="${product.isBest}"
                     class="badge bg-danger text-white rounded-end px-2 py-1 small mt-1">
                  BEST
                </div>

              </div>

              <div class="position-relative" style="height: 200px; overflow: hidden;">

                <!-- 슬라이더 등 이미지 요소들 -->
              </div>


              <!-- ❮ -->
              <button th:if="${product.imagePaths != null and product.imagePaths.size() > 1}"
                      class="slider-prev btn position-absolute top-50 start-0 translate-middle-y"
                      onclick="slideImage(this, -1, event)">❮</button>

              <!-- ❯ -->
              <button th:if="${product.imagePaths != null and product.imagePaths.size() > 1}"
                      class="slider-next btn position-absolute top-50 end-0 translate-middle-y"
                      onclick="slideImage(this, 1, event)">❯</button>


              <div th:if="${product.imagePaths.size() > 1}"
                   class="position-absolute bottom-0 start-50 translate-middle-x d-flex gap-1 mb-1">
          <span th:each="i : ${#numbers.sequence(0, #lists.size(product.imagePaths) - 1)}"
                class="dot bg-dark rounded-circle"
                th:attr="data-index=${i}"
                style="width: 6px; height: 6px; opacity: 0.4;"></span>
              </div>
            </div>

            <!-- 텍스트 영역 -->
            <div class="card-body">
              <h5 class="card-title" th:text="${product.title}">상품명</h5>
              <p class="card-text fw-bold" th:text="${#numbers.formatInteger(product.price, 3, 'COMMA') + '원'}">가격</p>

              <!-- 거래 방식 또는 위치/시간 정보 -->
              <p class="card-text text-muted small">
                <!-- 택배 단독 체크된 경우 -->
                <span th:if="${product.isDelivery == true and product.isDirect != true and product.isNonface != true}"
                      th:text="'택배전용 · ' + ${product.relativeTime}"></span>

                <!-- 그 외: 동네 있음 -->
                <span th:if="${!(product.isDelivery == true and product.isDirect != true and product.isNonface != true)
                  and product.dongName != null and !#strings.isEmpty(product.dongName)}"
                      th:text="${product.dongName + ' · ' + product.relativeTime}"></span>

                <!-- 그 외: 동네 없음 -->
                <span th:if="${!(product.isDelivery == true and product.isDirect != true and product.isNonface != true)
                  and (product.dongName == null or #strings.isEmpty(product.dongName))}"
                      th:text="${product.relativeTime}"></span>
              </p>
            </div>
          </div>
        </a>
      </div>

    </div>
  </div>
    </div>

    <!-- 상품 슬라이드 기능 스크립트 로드 -->

    <script th:inline="javascript">
      const isLoggedIn = [[${session.loginUser != null}]];

      function goToProductForm() {
        if (!isLoggedIn) {
          alert("로그인이 필요합니다.");
          window.location.href = "/member/login";
        } else {
          window.location.href = "/products/new";
        }
      }
    </script>
    <script th:src="@{/js/product.js}"></script>
    <script th:src="@{/js/render.js}"></script>

  </div>
  <link rel="stylesheet" th:href="@{/css/product.css}" />
